<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เกมบิงโกออนไลน์</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
        }
        .bingo-card {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }
        .bingo-cell {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            aspect-ratio: 1 / 1;
            padding: 4px;
            font-size: 0.8rem;
            line-height: 1.2;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            word-break: break-word;
            border: 2px solid transparent;
        }
        .bingo-cell.selected {
            background-color: #f59e0b; /* amber-500 */
            color: white;
            transform: scale(1.05);
            border-color: #d97706; /* amber-600 */
        }
        .bingo-cell.marked {
             background-color: #22c55e; /* green-500 */
             color: white;
             text-decoration: line-through;
        }
        .bingo-cell.winning-line {
            background-color: #ef4444; /* red-500 */
            border-color: #b91c1c; /* red-700 */
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1.05); }
            50% { transform: scale(1.15); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        #keyword-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 12px;
        }
        .keyword-chip {
            cursor: pointer;
            padding: 12px 8px;
            border-radius: 8px;
            transition: all 0.2s ease-in-out;
            background-color: #f1f5f9;
            border: 1px solid #cbd5e1;
            text-align: center;
            font-size: 0.9rem;
            word-break: break-word;
            line-height: 1.3;
        }
        .keyword-chip:hover {
            border-color: #94a3b8;
            transform: translateY(-2px);
        }
        .keyword-chip.selected {
            background-color: #4f46e5;
            color: white;
            border-color: #312e81;
            transform: scale(1.05);
            font-weight: 600;
            box-shadow: 0 4px 14px 0 rgb(0 0 0 / 10%);
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-5xl mx-auto">
        
        <!-- Role Selection Screen -->
        <div id="role-selection-screen" class="bg-white text-center p-8 rounded-xl shadow-lg">
            <h1 class="text-4xl font-bold text-slate-700 mb-2">เกมบิงโกออนไลน์</h1>
            <p class="text-slate-500 mb-8">สร้างการเรียนรู้ที่สนุกสนานในห้องเรียนของคุณ</p>
            <div class="flex flex-col md:flex-row gap-4 justify-center">
                <button id="teacher-role-btn" class="bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-600 transition-colors shadow-md">สำหรับครู</button>
                <button id="student-btn" class="bg-amber-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-amber-600 transition-colors shadow-md">สำหรับนักเรียน</button>
            </div>
             <div class="mt-8 text-xs text-slate-400">
                <p>สถานะ: <span id="auth-status">กำลังตรวจสอบ...</span></p>
            </div>
        </div>
        
        <!-- Teacher Login/Register Screen -->
        <div id="teacher-login-screen" class="hidden bg-white p-8 rounded-xl shadow-lg">
             <h2 class="text-2xl font-bold mb-4 text-center">เข้าสู่ระบบสำหรับครู</h2>
             <div class="mb-4">
                <label for="teacher-email" class="block text-slate-700 mb-1">อีเมล</label>
                <input type="email" id="teacher-email" class="w-full p-3 border rounded-lg" placeholder="teacher@example.com">
            </div>
             <div class="mb-6">
                <label for="teacher-password" class="block text-slate-700 mb-1">รหัสผ่าน</label>
                <input type="password" id="teacher-password" class="w-full p-3 border rounded-lg" placeholder="••••••••">
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="teacher-login-btn" class="flex-1 bg-indigo-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-600">เข้าสู่ระบบ</button>
                <button id="teacher-register-btn" class="flex-1 bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600">สมัครสมาชิก</button>
            </div>
            <button id="login-back-btn" class="w-full mt-4 bg-slate-200 text-slate-700 font-bold py-2 px-6 rounded-lg hover:bg-slate-300">ย้อนกลับ</button>
        </div>

        <!-- Teacher: Dashboard Screen -->
        <div id="teacher-dashboard-screen" class="hidden bg-white p-8 rounded-xl shadow-lg">
            <div class="flex justify-between items-start mb-6">
                <div>
                     <h2 class="text-2xl font-bold mb-1">แดชบอร์ดของคุณครู</h2>
                     <p class="text-sm text-slate-500" id="dashboard-teacher-email"></p>
                </div>
                <button id="dashboard-logout-btn" class="bg-red-500 text-white font-bold py-1 px-3 text-sm rounded-lg hover:bg-red-600">ออกจากระบบ</button>
            </div>
            <button id="dashboard-create-new-btn" class="w-full bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-600 mb-6">สร้างเกมบิงโกใหม่</button>

            <div>
                <h3 class="text-xl font-bold border-b pb-2 mb-4">ประวัติเกมที่สร้าง</h3>
                <div id="past-games-list" class="space-y-3 max-h-80 overflow-y-auto">
                    <!-- Past games will be populated here -->
                </div>
                 <p id="no-games-message" class="hidden text-center text-slate-500 py-8">คุณยังไม่เคยสร้างเกม</p>
            </div>
        </div>


        <!-- Teacher: Create Game Screen -->
        <div id="teacher-create-screen" class="hidden bg-white p-8 rounded-xl shadow-lg">
            <h2 id="create-edit-title" class="text-2xl font-bold mb-4">สร้างเกมบิงโกใหม่</h2>

            <!-- AI Generator Section -->
            <div class="mb-6 p-4 border border-indigo-200 rounded-lg bg-indigo-50">
                <h3 class="font-bold text-lg mb-2 text-indigo-700">สร้างคำศัพท์ด้วย AI ✨</h3>
                <div class="mb-3">
                    <label for="ai-topic-input" class="block text-slate-700 mb-1">หัวข้อ</label>
                    <input type="text" id="ai-topic-input" class="w-full p-2 border rounded-lg" placeholder="เช่น สัตว์ในทะเล, อุปกรณ์วิทยาศาสตร์">
                </div>
                <div class="mb-3">
                    <label for="ai-count-input" class="block text-slate-700 mb-1">จำนวนคำที่ต้องการ (ขั้นต่ำ 24)</label>
                    <input type="number" id="ai-count-input" class="w-full p-2 border rounded-lg" value="30" min="24">
                </div>
                <button id="ai-generate-btn" class="w-full bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 flex items-center justify-center gap-2 disabled:bg-purple-400">
                    <div id="ai-button-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stars" viewBox="0 0 16 16">
                           <path d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828zM3.794 1.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387A1.73 1.73 0 0 0 4.593 5.9l-.387 1.162a.217.217 0 0 1-.412 0L3.407 5.9A1.73 1.73 0 0 0 2.31 4.807l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387A1.73 1.73 0 0 0 3.407 2.31zM10.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.16 1.16 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.16 1.16 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732z"/>
                        </svg>
                    </div>
                    <span id="ai-button-text">สร้างคำศัพท์ด้วย AI</span>
                </button>
            </div>

            <div class="mb-4">
                <label for="quiz-name-input" class="block text-slate-700 mb-1 font-semibold">ชื่อชุดคำศัพท์/เกม</label>
                <input type="text" id="quiz-name-input" class="w-full p-3 border rounded-lg" placeholder="เช่น คำศัพท์บทที่ 1">
            </div>
            <div class="mb-4">
                <label for="keywords-input" class="block text-slate-700 mb-1 font-semibold">รายการคำศัพท์ (ขั้นต่ำ 24 คำ, 1 คำต่อ 1 บรรทัด)</label>
                <textarea id="keywords-input" class="w-full h-48 p-3 border rounded-lg focus:ring-2 focus:ring-indigo-400" placeholder="คำที่ 1&#10;คำที่ 2&#10;คำที่ 3..."></textarea>
                <p id="keyword-count" class="text-sm text-slate-500 mt-2">จำนวนคำ: 0</p>
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="create-game-btn" class="flex-1 bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 disabled:bg-slate-300">สร้างและเริ่มเกม</button>
                <button id="create-back-to-dashboard-btn" class="flex-1 bg-slate-200 text-slate-700 font-bold py-2 px-6 rounded-lg hover:bg-slate-300">กลับไปที่แดชบอร์ด</button>
            </div>
        </div>
        
        <!-- Student: Join Game Screen -->
        <div id="student-join-screen" class="hidden bg-white p-8 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold mb-4">เข้าร่วมเกม (สำหรับนักเรียน)</h2>
            <div class="mb-4">
                <label for="game-code-input" class="block text-slate-700 mb-1">รหัสเข้าร่วมห้อง</label>
                <input type="text" id="game-code-input" class="w-full p-3 border rounded-lg uppercase" placeholder="กรอกรหัส 6 ตัว">
            </div>
            <div class="mb-6">
                <label for="student-name-input" class="block text-slate-700 mb-1">ชื่อผู้เล่น</label>
                <input type="text" id="student-name-input" class="w-full p-3 border rounded-lg" placeholder="กรอกชื่อของคุณ">
            </div>
            <div class="flex gap-4">
                <button id="join-game-btn" class="bg-amber-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-amber-600">เข้าร่วม</button>
                <button id="join-back-btn" class="bg-slate-200 text-slate-700 font-bold py-2 px-6 rounded-lg hover:bg-slate-300">ย้อนกลับ</button>
            </div>
        </div>
        
        <!-- Lobby/Keyword Selection Screen (for Student) -->
        
<!-- Lobby/Keyword Selection Screen (for Student) -->
        <div id="keyword-selection-screen" class="hidden bg-white p-8 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold">กรอกคำศัพท์ของคุณเอง</h2>
            <p class="text-slate-600 mb-4">กรอกคำศัพท์ที่ต้องการใช้ในบิงโก 24 คำ (1 คำต่อ 1 บรรทัด) แล้วกด "สร้างการ์ดบิงโก"</p>
            <textarea id="student-keywords-input" class="w-full h-48 p-3 border rounded-lg focus:ring-2 focus:ring-indigo-400 mb-2" placeholder="คำที่ 1&#10;คำที่ 2&#10;คำที่ 3..."></textarea>
            <p class="font-bold text-xl mb-4">กรอกแล้ว <span id="student-keyword-count">0</span>/24 คำ</p>
            <div class="mt-6">
                <h3 class="font-bold mb-2">ผู้เล่นในห้อง</h3>
                <ul id="lobby-player-list" class="list-disc list-inside text-slate-600"></ul>
            </div>
            <button id="create-bingo-card-btn" class="mt-6 bg-blue-500 text-white font-bold py-3 px-6 rounded-lg w-full hover:bg-blue-600 disabled:bg-slate-300">สร้างการ์ดบิงโก</button>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden">
            <div class="flex flex-col lg:flex-row gap-6">
                <!-- Teacher View: QR Code Panel (Left) -->
                <div id="teacher-qr-panel" class="hidden w-full lg:w-1/3 bg-white p-6 rounded-xl shadow-lg text-center">
                    <h3 class="text-2xl font-bold mb-4">ให้นักเรียนเข้าร่วม</h3>
                    <div id="qrcode" class="p-4 bg-white inline-block rounded-lg shadow-md mx-auto"></div>
                    <p class="text-lg mt-4">หรือใช้รหัส:</p>
                    <p id="game-code-display-teacher" class="text-5xl font-bold text-indigo-600 tracking-widest my-2"></p>
                </div>
                
                <!-- Main Game Panel (Student View or Right Panel for Teacher) -->
                <div id="main-game-panel" class="w-full">
                    <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                        <div id="student-game-view">
                             <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h2 class="text-xl font-bold">ห้อง: <span id="game-code-display" class="text-indigo-600"></span></h2>
                                    <p class="text-sm text-slate-500">ผู้เล่น: <span id="player-name-display"></span></p>
                                </div>
                                <button id="bingo-btn" class="bg-rose-500 text-white font-extrabold text-2xl py-2 px-8 rounded-lg shadow-lg hover:bg-rose-600 transform hover:scale-105 transition-all">BINGO!</button>
                            </div>
                            <div id="bingo-card-container" class="bingo-card"></div>
                        </div>

                        <div id="teacher-main-controls" class="hidden">
                             <div id="teacher-controls">
                                <h3 class="text-xl font-bold mb-4">แผงควบคุม</h3>
                                <div id="winner-announcement" class="hidden mb-4 text-center p-4 bg-yellow-100 rounded-lg">
                                    <p class="font-bold text-lg text-yellow-800">🎉 BINGO! 🎉</p>
                                    <p id="winner-name-text" class="text-yellow-700"></p>
                                    <button id="view-winner-card-btn" class="mt-2 text-sm text-indigo-600 hover:underline">ดูการ์ดของผู้ชนะ</button>
                                </div>
                                 <button id="draw-keyword-btn" class="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-colors shadow-md mb-4">สุ่มคำศัพท์ใหม่</button>
                                 <button id="reset-game-btn" class="w-full bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors mb-2">รีเซ็ตเกม</button>
                                 <button id="end-game-and-back-to-dashboard-btn" class="w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">จบเกมและกลับแดชบอร์ด</button>
                                 <div class="mt-4">
                                    <h4 class="font-bold">ผู้เล่นในห้อง:</h4>
                                    <ul id="game-player-list" class="list-disc list-inside text-slate-600 mt-2 max-h-40 overflow-y-auto"></ul>
                                </div>
                            </div>
                            <div id="student-info">
                                <h3 class="text-xl font-bold mb-2">คำที่สุ่มได้ล่าสุด</h3>
                                <div id="last-drawn-keyword" class="w-full bg-amber-100 border-2 border-amber-400 text-amber-800 text-2xl font-bold p-4 rounded-lg text-center min-h-[80px] flex items-center justify-center">รอครูเริ่มเกม...</div>
                            </div>
                            <div class="mt-4">
                                <h4 class="text-lg font-bold mb-2">ประวัติคำที่สุ่มได้ (<span id="drawn-count">0</span>)</h4>
                                <div id="drawn-keywords-list" class="flex flex-wrap gap-2 bg-slate-50 p-3 rounded-lg max-h-48 overflow-y-auto border"></div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        
        <!-- General Purpose Modal -->
        <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div id="modal-content" class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full text-center">
                <h3 id="modal-title" class="text-2xl font-bold mb-4"></h3>
                <p id="modal-body" class="text-slate-600 mb-6"></p>
                <div id="modal-winner-card-container" class="hidden my-4 flex justify-center"></div>
                <button id="modal-close-btn" class="bg-indigo-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-600">ตกลง</button>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full text-center">
                <h3 id="confirm-modal-title" class="text-2xl font-bold mb-4"></h3>
                <p id="confirm-modal-body" class="text-slate-600 mb-6"></p>
                <div class="flex justify-center gap-4">
                    <button id="confirm-modal-yes-btn" class="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600">ยืนยัน</button>
                    <button id="confirm-modal-no-btn" class="bg-slate-200 text-slate-700 font-bold py-2 px-6 rounded-lg hover:bg-slate-300">ยกเลิก</button>
                </div>
            </div>
        </div>

        <!-- Profile Setup Modal -->
        <div id="profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full">
                <h3 class="text-2xl font-bold mb-4 text-center">ข้อมูลส่วนตัว</h3>
                <p class="text-slate-600 mb-6 text-center">กรุณากรอกข้อมูลของคุณเพื่อทำการสมัครสมาชิกให้เสร็จสมบูรณ์</p>
                <div class="mb-4">
                    <label for="profile-firstname" class="block text-slate-700 mb-1">ชื่อจริง</label>
                    <input type="text" id="profile-firstname" class="w-full p-3 border rounded-lg" placeholder="สมชาย">
                </div>
                <div class="mb-6">
                    <label for="profile-lastname" class="block text-slate-700 mb-1">นามสกุล</label>
                    <input type="text" id="profile-lastname" class="w-full p-3 border rounded-lg" placeholder="รักเรียน">
                </div>
                <button id="profile-save-btn" class="w-full bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600">บันทึกข้อมูล</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, off, remove, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        //firebaseConfig
        const firebaseConfig = {
            apiKey: "AIzaSyCHorq3avjAHUBvM-MRy2A819UGU5rjfhY",
            authDomain: "bingo-8ab85.firebaseapp.com",
            databaseURL: "https://bingo-8ab85-default-rtdb.firebaseio.com",
            projectId: "bingo-8ab85",
            storageBucket: "bingo-8ab85.firebasestorage.app",
            messagingSenderId: "524768299206",
            appId: "1:524768299206:web:e952fb06f28a330b39afc7",
            measurementId: "G-5Q7GBZJKGQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let currentGameCode = null;
        let currentGameRef = null;
        let currentPlayerRef = null;
        let gameListener = null;
        let editModeGameCode = null;
        const FREE_SPACE_KEYWORD = "FREE_SPACE";

        const screens = {
            role: document.getElementById('role-selection-screen'),
            teacherLogin: document.getElementById('teacher-login-screen'),
            teacherDashboard: document.getElementById('teacher-dashboard-screen'),
            teacherCreate: document.getElementById('teacher-create-screen'),
            studentJoin: document.getElementById('student-join-screen'),
            keywordSelection: document.getElementById('keyword-selection-screen'),
            game: document.getElementById('game-screen'),
        };

        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalWinnerCardContainer = document.getElementById('modal-winner-card-container');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        
        const profileModal = document.getElementById('profile-modal');
        
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalBody = document.getElementById('confirm-modal-body');
        const confirmModalNoBtn = document.getElementById('confirm-modal-no-btn');
        
        const showScreen = (screenName) => {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            if(screens[screenName]) screens[screenName].classList.remove('hidden');
        };

        const showModal = (title, body, winnerCardInfo = null) => {
            modalTitle.textContent = title;
            modalBody.textContent = body;
            modalWinnerCardContainer.classList.add('hidden'); // Reset
            if (winnerCardInfo) {
                modalWinnerCardContainer.innerHTML = '';
                const bingoCardDiv = document.createElement('div');
                bingoCardDiv.className = 'bingo-card mx-auto w-full max-w-[250px]';
                modalWinnerCardContainer.appendChild(bingoCardDiv);
                renderBingoCard(winnerCardInfo.card, winnerCardInfo.drawnKeywords, winnerCardInfo.winPattern, bingoCardDiv);
                modalWinnerCardContainer.classList.remove('hidden');
            }
            modal.classList.remove('hidden');
        };

        const showConfirmModal = (title, body, onConfirm) => {
            confirmModalTitle.textContent = title;
            confirmModalBody.textContent = body;
            confirmModal.classList.remove('hidden');
            
            const confirmModalYesBtn = document.getElementById('confirm-modal-yes-btn');
            const newYesBtn = confirmModalYesBtn.cloneNode(true);
            confirmModalYesBtn.parentNode.replaceChild(newYesBtn, confirmModalYesBtn);
            
            newYesBtn.onclick = () => {
                confirmModal.classList.add('hidden');
                if (onConfirm) onConfirm();
            };
        };

        modalCloseBtn.onclick = () => modal.classList.add('hidden');
        confirmModalNoBtn.onclick = () => confirmModal.classList.add('hidden');
        
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            const authStatusSpan = document.getElementById('auth-status');
            if (user && !user.isAnonymous) {
                const userProfileRef = ref(db, `users/${user.uid}`);
                const profileSnapshot = await get(userProfileRef);
                if (profileSnapshot.exists()) {
                    const profile = profileSnapshot.val();
                    authStatusSpan.textContent = `ครู: ${profile.firstName}`;
                    showTeacherDashboard();
                } else {
                    profileModal.classList.remove('hidden');
                }
            } else if (user && user.isAnonymous) {
                authStatusSpan.textContent = "เชื่อมต่อในฐานะผู้เล่นทั่วไป";
            } else {
                authStatusSpan.textContent = "ยังไม่ได้เชื่อมต่อ";
                signInAnonymously(auth).catch(e => console.error("Anonymous sign-in failed", e));
            }
        });
        
        const getFirebaseAuthErrorMessage = (errorCode) => {
            switch (errorCode) {
                case 'auth/invalid-email': return 'รูปแบบอีเมลไม่ถูกต้อง กรุณาตรวจสอบอีกครั้ง';
                case 'auth/user-not-found': return 'ไม่พบบัญชีผู้ใช้นี้ในระบบ กรุณาตรวจสอบอีเมลหรือสมัครสมาชิก';
                case 'auth/wrong-password': return 'รหัสผ่านไม่ถูกต้อง กรุณาลองอีกครั้ง';
                case 'auth/email-already-in-use': return 'อีเมลนี้มีผู้ใช้งานในระบบแล้ว กรุณาใช้อีเมลอื่น';
                case 'auth/weak-password': return 'รหัสผ่านไม่ปลอดภัย กรุณาตั้งรหัสผ่านอย่างน้อย 6 ตัวอักษร';
                default: return 'เกิดข้อผิดพลาดบางอย่าง กรุณาลองใหม่อีกครั้ง';
            }
        };

        document.getElementById('teacher-role-btn').onclick = () => {
            if (currentUser && !currentUser.isAnonymous) showTeacherDashboard();
            else showScreen('teacherLogin');
        };
        document.getElementById('student-btn').onclick = () => showScreen('studentJoin');
        document.getElementById('login-back-btn').onclick = () => showScreen('role');
        document.getElementById('join-back-btn').onclick = () => showScreen('role');
        
        document.getElementById('dashboard-create-new-btn').onclick = () => {
            editModeGameCode = null;
            document.getElementById('create-edit-title').textContent = 'สร้างเกมบิงโกใหม่';
            document.getElementById('quiz-name-input').value = '';
            document.getElementById('keywords-input').value = '';
            document.getElementById('keywords-input').dispatchEvent(new Event('input'));
            document.getElementById('create-game-btn').textContent = 'สร้างและเริ่มเกม';
            showScreen('teacherCreate');
        };
        
        document.getElementById('create-back-to-dashboard-btn').onclick = () => showTeacherDashboard();
        
        document.getElementById('teacher-login-btn').onclick = () => {
            const email = document.getElementById('teacher-email').value.trim();
            const pass = document.getElementById('teacher-password').value.trim();
            if (!email || !pass) return showModal("ข้อมูลไม่ครบถ้วน", "กรุณากรอกอีเมลและรหัสผ่านให้ครบถ้วน");
            signInWithEmailAndPassword(auth, email, pass).catch(err => {
                showModal("เกิดข้อผิดพลาด", getFirebaseAuthErrorMessage(err.code));
            });
        };
        
        document.getElementById('teacher-register-btn').onclick = () => {
            const email = document.getElementById('teacher-email').value.trim();
            const pass = document.getElementById('teacher-password').value.trim();
            if (!email || !pass) return showModal("ข้อมูลไม่ครบถ้วน", "กรุณากรอกอีเมลและรหัสผ่านให้ครบถ้วน");
            createUserWithEmailAndPassword(auth, email, pass).catch(err => {
                showModal("เกิดข้อผิดพลาด", getFirebaseAuthErrorMessage(err.code));
            });
        };

        document.getElementById('dashboard-logout-btn').onclick = () => {
            signOut(auth).then(() => showScreen('role'));
        };

        document.getElementById('profile-save-btn').onclick = async () => {
            const firstName = document.getElementById('profile-firstname').value.trim();
            const lastName = document.getElementById('profile-lastname').value.trim();
            if (!firstName || !lastName) return showModal("ข้อมูลไม่ครบถ้วน", "กรุณากรอกชื่อและนามสกุล");
            if (currentUser) {
                const userProfileRef = ref(db, `users/${currentUser.uid}`);
                await set(userProfileRef, { firstName, lastName, email: currentUser.email });
                profileModal.classList.add('hidden');
                await showTeacherDashboard();
            }
        };

        const showTeacherDashboard = async () => {
            if (!currentUser || currentUser.isAnonymous) return;
            const userProfileRef = ref(db, `users/${currentUser.uid}`);
            const profileSnapshot = await get(userProfileRef);
            if (profileSnapshot.exists()) {
                 document.getElementById('dashboard-teacher-email').textContent = `บัญชี: ${profileSnapshot.val().firstName} (${profileSnapshot.val().email})`;
            }
           
            showScreen('teacherDashboard');

            const pastGamesList = document.getElementById('past-games-list');
            const noGamesMessage = document.getElementById('no-games-message');
            pastGamesList.innerHTML = 'กำลังโหลดประวัติ...';
            noGamesMessage.classList.add('hidden');

            const teacherGamesRef = ref(db, `teacher_games/${currentUser.uid}`);
            const snapshot = await get(teacherGamesRef);

            if (snapshot.exists()) {
                pastGamesList.innerHTML = '';
                const gamesData = snapshot.val();
                Object.entries(gamesData).reverse().forEach(([gameCode, gameInfo]) => {
                    const gameElement = document.createElement('div');
                    gameElement.className = "p-3 bg-white border rounded-lg flex justify-between items-center";
                    const gameDate = new Date(gameInfo.createdAt).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'});
                    gameElement.innerHTML = `
                        <div>
                            <p class="font-bold text-slate-800">${gameInfo.quizName || 'ไม่มีชื่อ'}</p>
                            <p class="text-sm text-slate-500">สร้างเมื่อ: ${gameDate}</p>
                        </div>
                        <div class="flex flex-wrap gap-2 justify-end">
                           <button class="edit-past-game-btn bg-yellow-500 text-white text-sm font-bold py-1 px-3 rounded hover:bg-yellow-600" data-code="${gameCode}">แก้ไข</button>
                           <button class="start-past-game-btn bg-blue-500 text-white text-sm font-bold py-1 px-3 rounded hover:bg-blue-600" data-code="${gameCode}">เริ่มเกมนี้</button>
                           <button class="delete-past-game-btn bg-red-500 text-white text-sm font-bold py-1 px-3 rounded hover:bg-red-600" data-code="${gameCode}">ลบ</button>
                        </div>
                    `;
                    pastGamesList.appendChild(gameElement);
                });

                document.querySelectorAll('.edit-past-game-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => prepareEditScreen(e.target.dataset.code));
                });

                document.querySelectorAll('.start-past-game-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const pastGameCode = e.target.dataset.code;
                        const pastGameInfoRef = ref(db, `teacher_games/${currentUser.uid}/${pastGameCode}`);
                        const infoSnapshot = await get(pastGameInfoRef);
                        if (infoSnapshot.exists()) {
                            const gameInfo = infoSnapshot.val();
                            if (gameInfo.keywords && Array.isArray(gameInfo.keywords)) {
                                await startGameFromPreset(gameInfo.quizName, gameInfo.keywords);
                            } else {
                                showModal('ไม่สามารถเริ่มเกมได้', 'ขออภัย, ไม่พบชุดคำศัพท์สำหรับเกมที่บันทึกไว้นี้ อาจเป็นเกมที่สร้างด้วยเวอร์ชันเก่า');
                            }
                        }
                    });
                });

                 document.querySelectorAll('.delete-past-game-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const gameCodeToDelete = e.target.dataset.code;
                        showConfirmModal(
                            'ยืนยันการลบ',
                            'คุณแน่ใจหรือไม่ว่าต้องการลบประวัติเกมนี้? การกระทำนี้ไม่สามารถย้อนกลับได้',
                            async () => {
                                const gameHistoryRef = ref(db, `teacher_games/${currentUser.uid}/${gameCodeToDelete}`);
                                await remove(gameHistoryRef);
                                showModal('ลบสำเร็จ', 'ประวัติเกมถูกลบเรียบร้อยแล้ว');
                                showTeacherDashboard(); // Refresh the dashboard view
                            }
                        );
                    });
                });
            } else {
                pastGamesList.innerHTML = '';
                noGamesMessage.classList.remove('hidden');
            }
        };

        const prepareEditScreen = async (gameCode) => {
            const gameInfoRef = ref(db, `teacher_games/${currentUser.uid}/${gameCode}`);
            const snapshot = await get(gameInfoRef);
            if(snapshot.exists()) {
                const gameInfo = snapshot.val();
                editModeGameCode = gameCode;
                
                document.getElementById('create-edit-title').textContent = 'แก้ไขชุดคำศัพท์';
                document.getElementById('quiz-name-input').value = gameInfo.quizName || '';
                document.getElementById('keywords-input').value = (gameInfo.keywords || []).join('\n');
                document.getElementById('keywords-input').dispatchEvent(new Event('input'));
                document.getElementById('create-game-btn').textContent = 'บันทึกการแก้ไข';
                
                showScreen('teacherCreate');
            } else {
                showModal('เกิดข้อผิดพลาด', 'ไม่พบข้อมูลเกมที่ต้องการแก้ไข');
            }
        };

        const startGameFromPreset = async (quizName, keywords) => {
             const newGameCode = Math.random().toString(36).substring(2, 8).toUpperCase();
             const gameData = {
                teacherId: currentUser.uid,
                quizName: quizName,
                status: 'waiting',
                keywords: keywords,
                drawnKeywords: [],
                players: {},
                createdAt: new Date().toISOString()
            };
            await set(ref(db, `games/${newGameCode}`), gameData);
            await joinGame(newGameCode, 'ครูผู้สอน', true);
        };

        const keywordsInput = document.getElementById('keywords-input');
        const createGameBtn = document.getElementById('create-game-btn');
        keywordsInput.addEventListener('input', () => {
            const keywords = keywordsInput.value.trim().split('\n').filter(k => k.trim() !== '');
            document.getElementById('keyword-count').textContent = `จำนวนคำ: ${keywords.length}`;
            createGameBtn.disabled = keywords.length < 24;
        });

        createGameBtn.onclick = async () => {
            const quizName = document.getElementById('quiz-name-input').value.trim();
            if (!quizName) return showModal("ข้อมูลไม่ครบถ้วน", "กรุณาตั้งชื่อชุดคำศัพท์/เกม");
            
            const keywords = keywordsInput.value.trim().split('\n').filter(k => k.trim() !== '');
            if (keywords.length < 24) return showModal("ข้อมูลไม่ครบถ้วน", "ต้องมีคำศัพท์อย่างน้อย 24 คำ");

            if (editModeGameCode) {
                // --- EDIT LOGIC ---
                const gameHistoryRef = ref(db, `teacher_games/${currentUser.uid}/${editModeGameCode}`);
                await update(gameHistoryRef, { quizName, keywords });
                showModal('บันทึกสำเร็จ', 'ชุดคำศัพท์ของคุณถูกแก้ไขเรียบร้อยแล้ว');
                editModeGameCode = null;
                showTeacherDashboard();
            } else {
                // --- CREATE LOGIC ---
                const newGameCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                const createdAt = new Date().toISOString();
                const gameData = {
                    teacherId: currentUser.uid, quizName, status: 'waiting', keywords,
                    drawnKeywords: [], players: {}, createdAt
                };
                const updates = {};
                updates[`/games/${newGameCode}`] = gameData;
                updates[`/teacher_games/${currentUser.uid}/${newGameCode}`] = { quizName, createdAt, keywords };
                await update(ref(db), updates);
                await joinGame(newGameCode, 'ครูผู้สอน', true);
            }
        };
        
        document.getElementById('end-game-and-back-to-dashboard-btn').onclick = () => {
            showConfirmModal(
                'ยืนยันการจบเกม',
                'คุณต้องการจบเกมนี้และกลับไปที่หน้าแดชบอร์ดใช่หรือไม่? การกระทำนี้จะลบห้องเกมปัจจุบัน',
                async () => {
                    if(gameListener) off(currentGameRef, 'value', gameListener);
                    if(currentGameRef) await remove(currentGameRef);
                    
                    currentGameCode = null;
                    currentGameRef = null;
                    currentPlayerRef = null;
                    gameListener = null;

                    showTeacherDashboard();
                }
            );
        };
        
        document.getElementById('reset-game-btn').onclick = () => {
            showConfirmModal(
                'ยืนยันการรีเซ็ตเกม',
                'คุณแน่ใจหรือไม่ว่าต้องการรีเซ็ตเกม? ผู้เล่นทุกคนจะต้องสร้างการ์ดใหม่',
                async () => {
                    const playersSnapshot = await get(ref(db, `games/${currentGameCode}/players`));
                    if (!playersSnapshot.exists()) return;
                    const players = playersSnapshot.val();
                    const updates = {};
                    updates[`/games/${currentGameCode}/status`] = 'waiting';
                    updates[`/games/${currentGameCode}/drawnKeywords`] = [];
                    updates[`/games/${currentGameCode}/winner`] = null;

                    Object.keys(players).forEach(uid => {
                        updates[`/games/${currentGameCode}/players/${uid}/card`] = [];
                        updates[`/games/${currentGameCode}/players/${uid}/isReady`] = players[uid].isTeacher;
                    });
                    await update(ref(db), updates);
                    showModal("รีเซ็ตเกม", "เกมถูกรีเซ็ตแล้ว ผู้เล่นจะต้องเลือกคีย์เวิร์ดอีกครั้ง");
                }
            );
        };

        document.getElementById('join-game-btn').onclick = async () => {
            if (!auth.currentUser) {
                showModal("กำลังเชื่อมต่อ", "กรุณารอสักครู่และลองอีกครั้ง");
                return;
            }
            const gameCode = document.getElementById('game-code-input').value.trim().toUpperCase();
            const studentName = document.getElementById('student-name-input').value.trim();

            if (!gameCode || !studentName) return showModal("ข้อมูลไม่ครบถ้วน", "กรุณากรอกรหัสเข้าร่วมและชื่อผู้เล่น");
            
            const gameRefCheck = ref(db, `games/${gameCode}`);
            const snapshot = await get(gameRefCheck);
            if (!snapshot.exists()) return showModal("ไม่พบห้องเกม", "รหัสเข้าร่วมไม่ถูกต้อง");

            const gameData = snapshot.val();
            if (gameData.players && Object.values(gameData.players).find(p => p.name === studentName)) {
                return showModal("ชื่อซ้ำ", "มีผู้เล่นใช้ชื่อนี้ในห้องแล้ว กรุณาใช้ชื่ออื่น");
            }
            await joinGame(gameCode, studentName, false);
        };

        const joinGame = async (gameCode, playerName, isTeacher) => {
            if (!auth.currentUser) {
                showModal("เกิดข้อผิดพลาด", "ไม่สามารถเข้าร่วมเกมได้เนื่องจากไม่ได้ยืนยันตัวตน");
                return;
            }
            currentGameCode = gameCode;
            currentGameRef = ref(db, `games/${gameCode}`);
            
            const playerInfo = { name: playerName, isTeacher, isReady: isTeacher, card: [] };
            
            const uid = auth.currentUser.uid;
            currentPlayerRef = ref(db, `games/${gameCode}/players/${uid}`);
            await set(currentPlayerRef, playerInfo);

            if (isTeacher) {
                setupGameScreen(isTeacher, playerName);
            } else {
                setupKeywordSelectionScreen();
            }

            if (gameListener) off(currentGameRef, 'value', gameListener);
            gameListener = onValue(currentGameRef, (snapshot) => {
                if (snapshot.exists()) {
                    updateUIWithGameData(snapshot.val(), isTeacher);
                } else {
                    if (screens.game.classList.contains('hidden')) return;
                    cleanupAndExit("ห้องเกมถูกปิดแล้ว", "ครูได้ทำการปิดห้องเกมนี้แล้ว");
                }
            });
        };
        
        // ...existing code...
        const setupKeywordSelectionScreen = () => {
            showScreen('keywordSelection');
            const textarea = document.getElementById('student-keywords-input');
            const countSpan = document.getElementById('student-keyword-count');
            const createCardBtn = document.getElementById('create-bingo-card-btn');
            textarea.value = '';
            countSpan.textContent = '0';
            createCardBtn.disabled = true;

            textarea.oninput = () => {
                const keywords = textarea.value.trim().split('\n').filter(k => k.trim() !== '');
                countSpan.textContent = keywords.length;
                createCardBtn.disabled = keywords.length !== 24;
            };

            createCardBtn.onclick = async () => {
                let cardKeywords = textarea.value.trim().split('\n').filter(k => k.trim() !== '');
                if (cardKeywords.length !== 24) return;
                cardKeywords = cardKeywords.sort(() => Math.random() - 0.5);
                cardKeywords.splice(12, 0, FREE_SPACE_KEYWORD);

                const uid = auth.currentUser.uid;
                const updates = {};
                updates[`/games/${currentGameCode}/players/${uid}/card`] = cardKeywords;
                updates[`/games/${currentGameCode}/players/${uid}/isReady`] = true;
                await update(ref(db), updates);
            };
        };
        // ...existing code...

        const setupGameScreen = (isTeacher, playerName) => {
            showScreen('game');
            // Hide all panels first, then show the correct ones
            document.getElementById('teacher-qr-panel').classList.add('hidden');
            document.getElementById('teacher-main-controls').classList.add('hidden');
            document.getElementById('student-game-view').classList.add('hidden');

            if (isTeacher) {
                document.getElementById('teacher-qr-panel').classList.remove('hidden');
                document.getElementById('teacher-main-controls').classList.remove('hidden');
                document.getElementById('game-code-display-teacher').textContent = currentGameCode;
                generateQRCode(currentGameCode);
            } else {
                document.getElementById('student-game-view').classList.remove('hidden');
                document.getElementById('game-code-display').textContent = currentGameCode;
                document.getElementById('player-name-display').textContent = playerName;
            }
        };
        
        const generateQRCode = (gameCode) => {
            const qrCodeContainer = document.getElementById('qrcode');
            qrCodeContainer.innerHTML = 'https://rppx49.github.io/bingo/';
            //เปลี่ยน URL ให้ตรงกับที่คุณต้องการ เฉพาะ https://rppx49.github.io/bingo/
            const joinURL = `https://rppx49.github.io/bingo/?game_code=${gameCode}`;
            new QRCode(qrCodeContainer, {
                text: joinURL,
                width: 200,
                height: 200,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        };
        
        const updateUIWithGameData = (gameData, isTeacher) => {
            const uid = auth.currentUser.uid;
            const me = gameData.players[uid];
            if (!me) {
                 if(isTeacher) return;
                 return cleanupAndExit("คุณออกจากเกมแล้ว", "คุณไม่ได้อยู่ในห้องเกมนี้อีกต่อไป");
            }
            
            if (!isTeacher && !me.isReady) {
                 if (screens.keywordSelection.classList.contains('hidden')) setupKeywordSelectionScreen();
                 const lobbyPlayerList = document.getElementById('lobby-player-list');
                 lobbyPlayerList.innerHTML = '';
                 Object.values(gameData.players).forEach(p => {
                    const li = document.createElement('li');
                    li.textContent = `${p.name} ${p.isReady ? '✅' : '...'}`;
                    lobbyPlayerList.appendChild(li);
                 });
                 return;
            }

            if (screens.game.classList.contains('hidden')) setupGameScreen(isTeacher, me.name);
            
            if (!isTeacher) {
                const isWinner = gameData.winner && gameData.winner.uid === uid;
                renderBingoCard(me.card || [], gameData.drawnKeywords || [], isWinner ? gameData.winner.pattern : []);
            }
            
            const drawnKeywords = gameData.drawnKeywords || [];
            document.getElementById('drawn-count').textContent = drawnKeywords.length;
            document.getElementById('last-drawn-keyword').textContent = drawnKeywords.length > 0 ? drawnKeywords.slice(-1)[0] : 'รอครูเริ่มเกม...';
            const drawnList = document.getElementById('drawn-keywords-list');
            drawnList.innerHTML = '';
            drawnKeywords.slice().reverse().forEach(keyword => {
                const span = document.createElement('span');
                span.className = 'bg-white px-2 py-1 rounded text-sm border';
                span.textContent = keyword;
                drawnList.appendChild(span);
            });
            
            const isFinished = gameData.status === 'finished';

            if (isTeacher) {
                const allKeywords = gameData.keywords || [];
                const remaining = new Set(allKeywords.filter(x => !new Set(drawnKeywords).has(x)));
                document.getElementById('draw-keyword-btn').disabled = remaining.size === 0 || isFinished;
                
                const winnerAnnounce = document.getElementById('winner-announcement');
                if (isFinished && gameData.winner) {
                    document.getElementById('winner-name-text').textContent = `ผู้ชนะ: ${gameData.winner.name}`;
                    winnerAnnounce.classList.remove('hidden');
                } else {
                    winnerAnnounce.classList.add('hidden');
                }
                
                const gamePlayerList = document.getElementById('game-player-list');
                gamePlayerList.innerHTML = '';
                const playersArray = Object.values(gameData.players || {});
                if (playersArray.length > 1) {
                    playersArray.forEach(player => {
                        if (player.isTeacher) return;
                        const li = document.createElement('li');
                        li.textContent = player.name;
                        gamePlayerList.appendChild(li);
                    });
                } else {
                    gamePlayerList.innerHTML = '<li class="text-slate-500 list-none">ยังไม่มีผู้เล่นเข้าร่วม</li>';
                }
            } else {
                 document.getElementById('bingo-btn').disabled = isFinished;
            }
        };

        const renderBingoCard = (cardData, drawnKeywords, winPattern = [], container = document.getElementById('bingo-card-container')) => {
            const oldMarked = new Set(Array.from(container.querySelectorAll('.marked')).map(c => c.dataset.index));
            container.innerHTML = '';
            const drawnSet = new Set(drawnKeywords);
            const winSet = new Set(winPattern || []);

            cardData.forEach((keyword, index) => {
                const cell = document.createElement('div');
                const isFreeSpace = keyword === FREE_SPACE_KEYWORD;
                cell.textContent = isFreeSpace ? "ฟรี" : keyword;
                cell.className = 'bingo-cell bg-white/50 border border-slate-300/50 rounded-lg';
                cell.dataset.index = index;
                
                const isNowMarked = isFreeSpace || drawnSet.has(keyword);

                if (isNowMarked) {
                    cell.classList.add('marked');
                    if(!oldMarked.has(String(index))) {
                         cell.classList.add('pop-animation');
                    }
                }
                if (isFreeSpace) {
                    cell.classList.add('selected'); 
                }
                if(winSet.has(index)) {
                    cell.classList.add('winning-line');
                }

                if(cell.classList.contains('marked') && !isFreeSpace){
                    cell.onclick = () => cell.classList.toggle('selected');
                } else {
                    cell.style.cursor = 'not-allowed';
                }
                container.appendChild(cell);
            });
        };

        document.getElementById('draw-keyword-btn').onclick = async () => {
             const snapshot = await get(currentGameRef);
             const gameData = snapshot.val();
             if (gameData.status === 'finished') return;

             const remaining = [...(gameData.keywords || [])].filter(x => !(gameData.drawnKeywords || []).includes(x));
             if(remaining.length > 0) {
                 const newKeyword = remaining[Math.floor(Math.random() * remaining.length)];
                 const updates = {
                     [`/games/${currentGameCode}/drawnKeywords`]: [...(gameData.drawnKeywords || []), newKeyword],
                     [`/games/${currentGameCode}/status`]: 'playing'
                 };
                 await update(ref(db), updates);
             }
        };

        document.getElementById('view-winner-card-btn').onclick = async () => {
            const snapshot = await get(currentGameRef);
            const gameData = snapshot.val();
            if(!gameData.winner) return;
            const uid = gameData.winner.uid;
            const winnerPlayer = gameData.players[uid];
            showModal(
                `การ์ดของ ${gameData.winner.name}`, 
                `บิงโกด้วยแถวที่ถูกเน้นสี`,
                { 
                    card: winnerPlayer.card, 
                    drawnKeywords: gameData.drawnKeywords, 
                    winPattern: gameData.winner.pattern 
                }
            );
        };

        document.getElementById('bingo-btn').onclick = async () => {
            const selectedCells = document.querySelectorAll('#bingo-card-container .bingo-cell.selected');
            const snapshot = await get(currentGameRef);
            const gameData = snapshot.val();
            
            if (gameData.status === 'finished') return;

            const markedIndices = new Set(Array.from(selectedCells).map(c => parseInt(c.dataset.index)));
            const winPattern = checkWin(markedIndices);

            if (winPattern) {
                const uid = auth.currentUser.uid;
                const me = gameData.players[uid];
                const updates = {};
                updates[`/games/${currentGameCode}/status`] = 'finished';
                updates[`/games/${currentGameCode}/winner`] = { name: me.name, uid: uid, pattern: winPattern };
                await update(ref(db), updates);
            } else {
                showModal("ยังไม่บิงโก!", "ตรวจสอบการ์ดของคุณอีกครั้ง ยังไม่มีแถวที่ครบ 5 คำ");
            }
        };

        const checkWin = (markedIndices) => {
            const winPatterns = [
                [0, 1, 2, 3, 4], [5, 6, 7, 8, 9], [10, 11, 12, 13, 14], [15, 16, 17, 18, 19], [20, 21, 22, 23, 24],
                [0, 5, 10, 15, 20], [1, 6, 11, 16, 21], [2, 7, 12, 17, 22], [3, 8, 13, 18, 23], [4, 9, 14, 19, 24],
                [0, 6, 12, 18, 24], [4, 8, 12, 16, 20]
            ];
            for (const pattern of winPatterns) {
                if (pattern.every(index => markedIndices.has(index))) {
                    return pattern;
                }
            }
            return null;
        };

        const cleanupAndExit = (title, message) => {
             if (currentGameRef && gameListener) off(currentGameRef, 'value', gameListener);
             currentGameCode = null;
             currentGameRef = null;
             currentPlayerRef = null;
             gameListener = null;

             if(title && message) showModal(title, message);
             showScreen('role');
        };

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const gameCodeFromURL = urlParams.get('game_code');
            if (gameCodeFromURL) {
                document.getElementById('game-code-input').value = gameCodeFromURL.toUpperCase();
                showScreen('studentJoin');
            } else {
                showScreen('role');
            }
        });

        // --- AI Keyword Generator ---
        document.getElementById('ai-generate-btn').addEventListener('click', async () => {
            const aiGenerateBtn = document.getElementById('ai-generate-btn');
            const aiTopicInput = document.getElementById('ai-topic-input');
            const aiCountInput = document.getElementById('ai-count-input');
            const keywordsInput = document.getElementById('keywords-input');
            
            const topic = aiTopicInput.value.trim();
            const count = parseInt(aiCountInput.value, 10);

            if (!topic) {
                showModal('ต้องการหัวข้อ', 'กรุณาป้อนหัวข้อสำหรับสร้างคำศัพท์');
                return;
            }

            if (isNaN(count) || count < 24) {
                showModal('จำนวนไม่ถูกต้อง', 'กรุณาระบุจำนวนคำศัพท์อย่างน้อย 24 คำ');
                return;
            }

            const buttonText = document.getElementById('ai-button-text');
            const buttonIcon = document.getElementById('ai-button-icon');
            const originalButtonText = buttonText.textContent;
            
            aiGenerateBtn.disabled = true;
            buttonText.textContent = 'กำลังสร้าง...';
            buttonIcon.innerHTML = `<div class="spinner"></div>`;
            
            const apiKey = "AIzaSyAMyOGd4vDp_k_iVek2czas1ppe9lPUP34"; // Replace with your actual API key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const prompt = `Generate a list of ${count} unique keywords related to the topic: "${topic}". The keywords should be in Thai. Return only the keywords, one per line, without any numbering, bullet points, or additional text.`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: { temperature: 0.8, topK: 1, topP: 1, maxOutputTokens: 8192 },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Error:', errorData);
                    throw new Error(`API request failed with status ${response.status}.`);
                }
                
                const result = await response.json();

                if (result.candidates && result.candidates[0].content?.parts[0]?.text) {
                    const generatedText = result.candidates[0].content.parts[0].text;
                    keywordsInput.value = generatedText.trim();
                    keywordsInput.dispatchEvent(new Event('input', { bubbles: true }));
                } else {
                     if (result.promptFeedback && result.promptFeedback.blockReason) {
                        throw new Error(`Content blocked: ${result.promptFeedback.blockReason}`);
                    }
                    throw new Error('No content received from AI. Please try a different topic.');
                }

            } catch (error) {
                console.error('Error generating keywords with AI:', error);
                showModal('เกิดข้อผิดพลาด', `ไม่สามารถสร้างคำศัพท์จาก AI ได้: ${error.message}`);
            } finally {
                aiGenerateBtn.disabled = false;
                buttonText.textContent = originalButtonText;
                buttonIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stars" viewBox="0 0 16 16">
                           <path d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828zM3.794 1.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387A1.73 1.73 0 0 0 4.593 5.9l-.387 1.162a.217.217 0 0 1-.412 0L3.407 5.9A1.73 1.73 0 0 0 2.31 4.807l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387A1.73 1.73 0 0 0 3.407 2.31zM10.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.16 1.16 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.16 1.16 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732z"/>
                        </svg>`;
            }
        });

        window.addEventListener('beforeunload', () => {
             if (currentPlayerRef && !currentUser?.isTeacher) remove(currentPlayerRef);
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            showScreen('role');
        });

    </script>
</body>
</html>
